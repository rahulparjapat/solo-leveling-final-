<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <title>SSC Solo Leveling - Optimized</title>
    <style>
        :root {
            --bg-primary: #0d0d14; --bg-secondary: #1a1a2e; --bg-tertiary: #252540; --bg-card: #16162a;
            --text-primary: #e8e8f0; --text-secondary: #a0a0b8;
            --accent-blue: #4a9eff; --accent-green: #4ade80; --accent-yellow: #fbbf24; --accent-red: #ef4444;
            --border-color: #2a2a45; --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; overflow-x: hidden; }
        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; padding: 20px; padding-bottom: 100px; }
        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-family: inherit; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-success { background: var(--accent-green); color: #0d0d14; }
        .btn-secondary { background: var(--bg-tertiary); color: white; border: 1px solid var(--border-color); }
        .hidden { display: none !important; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat-card { background: var(--bg-card); padding: 12px; border-radius: var(--radius); text-align: center; border: 1px solid var(--border-color); }
        .progress-bar { height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: var(--accent-blue); width: 0%; transition: width 0.5s ease; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 10px; z-index: 100; max-width: 600px; margin: 0 auto; }
        .nav-item { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--accent-blue); }
        .camera-box { background: black; width: 100%; aspect-ratio: 4/3; position: relative; border-radius: 8px; overflow: hidden; margin-bottom: 12px; }
        video, .captured-img { width: 100%; height: 100%; object-fit: cover; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: white; margin-bottom: 12px; font-family: inherit; }
        .rank-badge { width: 50px; height: 50px; border-radius: 50%; background: var(--bg-tertiary); border: 2px solid var(--accent-blue); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); z-index: 1000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <div id="mainApp">
        <div class="app-container">
            <div id="pageDashboard" class="page">
                <div class="card flex" style="display:flex; align-items:center; gap:15px;">
                    <div class="rank-badge" id="dashRank">E</div>
                    <div>
                        <h2 id="dashLevel">Level 1</h2>
                        <div id="dashWeeklyXP" style="font-size: 0.8rem; color: var(--text-secondary);">Weekly: 0 / 800</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="font-size: 0.7rem; color: var(--text-secondary);">GOLD</div>
                        <div id="dashGold" style="color: var(--accent-yellow); font-weight: bold;">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 0.7rem; color: var(--text-secondary);">STREAK</div>
                        <div id="dashStreak" style="font-weight: bold;">0 Days</div>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; font-size: 0.8rem;">
                        <span>Level Progress</span>
                        <span id="xpText">0 / 100</span>
                    </div>
                    <div class="progress-bar"><div id="xpBar" class="progress-fill"></div></div>
                </div>

                <div class="card" style="border-left: 4px solid var(--accent-yellow);">
                    <div style="font-size: 0.7rem; color: var(--accent-yellow); font-weight: bold; margin-bottom: 4px;">DAILY QUEST</div>
                    <div id="questText">Study any subject for 30 mins</div>
                </div>

                <button class="btn btn-primary" onclick="showPage('study')">‚öîÔ∏è ENTER GATE (STUDY)</button>
            </div>

            <div id="pageStudy" class="page hidden">
                <div id="studyStep1">
                    <h3>Study Intent</h3>
                    <label style="font-size: 0.8rem; color: var(--text-secondary);">Subject</label>
                    <select id="studySubject" class="form-select">
                        <option value="Quant">Quantitative Aptitude</option>
                        <option value="English">English Language</option>
                        <option value="Reasoning">General Intelligence</option>
                        <option value="GA">General Awareness</option>
                    </select>
                    <label style="font-size: 0.8rem; color: var(--text-secondary);">Target (Min 10m)</label>
                    <input type="number" id="studyTarget" class="form-input" placeholder="Minutes">
                    <button class="btn btn-primary" onclick="startTimer()">Start Session</button>
                </div>

                <div id="studyStep2" class="hidden text-center">
                    <div id="timerDisplay" style="font-size: 4rem; font-weight: bold; margin: 30px 0; font-family: monospace;">00:00</div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Focus on the task. The system is watching.</p>
                    <button class="btn btn-success" onclick="stopTimer()">Finish Session</button>
                </div>

                <div id="studyStep3" class="hidden">
                    <h3>Verification Required</h3>
                    <div class="camera-box">
                        <video id="video" autoplay playsinline></video>
                        <img id="photoPreview" class="captured-img hidden">
                    </div>
                    <button class="btn btn-primary" id="captureBtn" onclick="takePhoto()" style="margin-bottom:10px;">üì∏ Take Photo of Notes</button>
                    <textarea id="studyNote" class="form-textarea" placeholder="Summary of what you learned (Min 20 chars)..."></textarea>
                    <button class="btn btn-success" onclick="submitVerification()">Verify & Submit</button>
                </div>
            </div>

            <div id="pageProfile" class="page hidden">
                <h3>Hunter Profile</h3>
                <div id="historyLog" style="margin-top: 15px;"></div>
                <button class="btn btn-secondary" onclick="exportData()" style="margin-top: 20px;">Download Progress Data</button>
            </div>
        </div>

        <nav class="nav-bar">
            <button class="nav-item active" id="nav-dashboard" onclick="showPage('dashboard')">Home</button>
            <button class="nav-item" id="nav-study" onclick="showPage('study')">Study</button>
            <button class="nav-item" id="nav-profile" onclick="showPage('profile')">Profile</button>
        </nav>
    </div>

    <script>
        // CONFIG & STATE
        const CONFIG = {
            minStudy: 10,
            baseRate: 20, // XP per hour
            levels: [
                { r: 'E', multi: 1.0, cap: 800 }, // L1-3
                { r: 'D', multi: 1.1, cap: 1200 }, // L4-5
                { r: 'C', multi: 1.25, cap: 1500 }, // L6-7
                { r: 'B', multi: 1.4, cap: 1800 }, // L8-9
                { r: 'A', multi: 1.6, cap: 2100 }, // L10-11
                { r: 'S', multi: 1.8, cap: 2500 }  // L12+
            ]
        };

        let state = JSON.parse(localStorage.getItem('ssc_solo_pro')) || {
            level: 1, xp: 0, gold: 0, weeklyXP: 0, history: [], streak: 0, lastDate: null
        };

        let activeSession = { startTime: null, timerInterval: null, photo: null };

        function saveState() {
            // STORAGE PROTECTION: Limit history to 50 entries to prevent QuotaExceededError
            if (state.history.length > 50) state.history = state.history.slice(0, 50);
            localStorage.setItem('ssc_solo_pro', JSON.stringify(state));
            updateUI();
        }

        // NAVIGATION
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1)).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + pageId).classList.add('active');
        }

        // LEVELING ENGINE
        function getLevelConfig(lvl) {
            if (lvl <= 3) return CONFIG.levels[0];
            if (lvl <= 5) return CONFIG.levels[1];
            if (lvl <= 7) return CONFIG.levels[2];
            if (lvl <= 9) return CONFIG.levels[3];
            if (lvl <= 11) return CONFIG.levels[4];
            return CONFIG.levels[5];
        }

        function getNextLevelXP(lvl) {
            return 100 * Math.pow(2, lvl - 1);
        }

        // TIMER LOGIC
        function startTimer() {
            const target = document.getElementById('studyTarget').value;
            if (target < CONFIG.minStudy) {
                showToast("Min 10 mins required!", "error");
                return;
            }
            activeSession.startTime = Date.now();
            document.getElementById('studyStep1').classList.add('hidden');
            document.getElementById('studyStep2').classList.remove('hidden');
            
            activeSession.timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - activeSession.startTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            const elapsedMins = (Date.now() - activeSession.startTime) / 60000;
            if (elapsedMins < CONFIG.minStudy) {
                showToast("FAILED: Time too short! -40 XP", "error");
                state.xp = Math.max(0, state.xp - 40);
                resetStudy();
                saveState();
                return;
            }
            clearInterval(activeSession.timerInterval);
            document.getElementById('studyStep2').classList.add('hidden');
            document.getElementById('studyStep3').classList.remove('hidden');
            initCamera();
        }

        // CAMERA & STORAGE SAVER
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('video').srcObject = stream;
            } catch (e) {
                showToast("Camera access denied", "error");
            }
        }

        
        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            
            // STORAGE PROTECTION: Force low resolution (320px wide)
            const scale = 320 / video.videoWidth;
            canvas.width = 320;
            canvas.height = video.videoHeight * scale;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // STORAGE PROTECTION: Use JPEG with 0.5 quality (Very small file size)
            const compressedData = canvas.toDataURL('image/jpeg', 0.5);
            
            activeSession.photo = compressedData;
            document.getElementById('photoPreview').src = compressedData;
            document.getElementById('photoPreview').classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('captureBtn').innerText = "Retake Photo";
        }

        function submitVerification() {
            const note = document.getElementById('studyNote').value;
            if (!activeSession.photo) return showToast("Photo required!", "error");
            if (note.length < 20) return showToast("Summary too short!", "error");

            const elapsedMins = (Date.now() - activeSession.startTime) / 60000;
            const config = getLevelConfig(state.level);
            
            // Formula: (mins/60) * 20 * multiplier
            const earnedXP = Math.floor((elapsedMins / 60) * CONFIG.baseRate * config.multi);
            const earnedGold = Math.floor(earnedXP / 4);

            state.xp += earnedXP;
            state.gold += earnedGold;
            state.weeklyXP += earnedXP;
            
            // Level Up logic
            let nextXP = getNextLevelXP(state.level);
            if (state.xp >= nextXP) {
                state.xp -= nextXP;
                state.level++;
                showToast("LEVEL UP! YOU ARE STRONGER.", "success");
            }

            state.history.unshift({
                date: new Date().toLocaleDateString(),
                sub: document.getElementById('studySubject').value,
                xp: earnedXP,
                mins: Math.floor(elapsedMins)
            });

            showToast(`+${earnedXP} XP | +${earnedGold} Gold`, "success");
            resetStudy();
            saveState();
            showPage('dashboard');
        }

        function resetStudy() {
            clearInterval(activeSession.timerInterval);
            activeSession = { startTime: null, timerInterval: null, photo: null };
            document.getElementById('studyStep1').classList.remove('hidden');
            document.getElementById('studyStep2').classList.add('hidden');
            document.getElementById('studyStep3').classList.add('hidden');
            document.getElementById('video').classList.remove('hidden');
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('studyNote').value = "";
            document.getElementById('captureBtn').innerText = "üì∏ Take Photo of Notes";
        }

        // UI RENDERING
        function updateUI() {
            const config = getLevelConfig(state.level);
            const nextXP = getNextLevelXP(state.level);

            document.getElementById('dashLevel').innerText = `Level ${state.level}`;
            document.getElementById('dashRank').innerText = config.r;
            document.getElementById('dashGold').innerText = state.gold;
            document.getElementById('dashWeeklyXP').innerText = `Weekly: ${state.weeklyXP} / ${config.cap}`;
            document.getElementById('xpText').innerText = `${Math.floor(state.xp)} / ${nextXP}`;
            document.getElementById('xpBar').style.width = (state.xp / nextXP * 100) + '%';

            // Profile Log
            document.getElementById('historyLog').innerHTML = state.history.map(h => `
                <div class="card" style="padding:10px; font-size:0.8rem; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${h.sub}</span>
                        <span style="color:var(--accent-blue)">+${h.xp} XP</span>
                    </div>
                    <div style="color:var(--text-secondary)">${h.date} ‚Ä¢ ${h.mins} mins</div>
                </div>
            `).join('');
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.borderColor = type === 'error' ? 'var(--accent-red)' : 'var(--accent-green)';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href",     dataStr);
            downloadAnchorNode.setAttribute("download", "ssc_solo_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // INIT
        updateUI();
    </script>
</body>
</html>
